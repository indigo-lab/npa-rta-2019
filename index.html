<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>npa-rta-2019</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@1.14.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@1.14.0/dist/maplibre-gl.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>"
  <style>
    .my-popup {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
  <script>
    function ExportControl() {}
    ExportControl.prototype = {
      onAdd: function(map) {
        this._map = map;
        this._container = document.createElement('div');
        this._container.className = 'mapboxgl-ctrl';
        const button = document.createElement('button');
        button.textContent = "Get GeoJSON";
        this._container.appendChild(button);
        button.addEventListener("click", function() {
          const json = {
            "type": "FeatureCollection",
            "features": map.queryRenderedFeatures()
          };
          const blob = new Blob([JSON.stringify(json, null, 2)], {
            type: "application/json;charset=utf-8"
          });
          saveAs(blob, `npa-rta-2019_${new Date().getTime()}.json`);
        });
        return this._container;
      },
      onRemove: function() {
        this._container.parentNode.removeChild(this._container);
        this._map = undefined;
      }
    };
  </script>
</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;bottom:0;right:0;"></div>
  <script>
    const base = new URL("./", location.href).toString().replace(/\/$/, "");
    const style = {
      "version": 8,
      "glyphs": "https://maps.gsi.go.jp/xyz/noto-jp/{fontstack}/{range}.pbf",
      "sources": {
        "pale": {
          "type": "raster",
          "tiles": [
            "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png"
          ],
          "minzoom": 5,
          "maxzoom": 18,
          "tileSize": 256,
          "attribution": "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>"
        },
        "npa-rta-2019": {
          "type": "vector",
          "tiles": [
            `${base}/{z}/{x}/{y}.pbf`
          ],
          "minzoom": 0,
          "maxzoom": 14,
          "attribution": "<a href='https://www.npa.go.jp/publications/statistics/koutsuu/opendata/index_opendata.html'>警察庁:交通事故統計情報のオープンデータ(2019年)</a> を加工して作成"
        }
      },
      "layers": [{
          "id": "pale",
          "type": "raster",
          "source": "pale",
          "minzoom": 5,
          "maxzoom": 24
        }, {
          "id": "heatmap",
          "type": "heatmap",
          "source": "npa-rta-2019",
          "source-layer": "npa-rta-2019",
          "minzoom": 0,
          "maxzoom": 24,
          "paint": {
            "heatmap-weight": ["case", ["has", "point_count"],
              ["get", "point_count"], 1
            ]
          },
          "layout": {
            "visibility": "none"
          }
        },
        {
          "id": "npa-rta-2019-cluster",
          "type": "circle",
          "source": "npa-rta-2019",
          "source-layer": "npa-rta-2019",
          "minzoom": 0,
          "maxzoom": 24,
          "filter": ["has", "point_count"],
          "paint": {
            "circle-color": ["interpolate",
              ["linear"],
              ["get", "point_count"],
              1, "#ffffff",
              2, "#ffff00",
              16, "#ff0000"
            ],
            "circle-radius": 8,
            "circle-stroke-width": 1,
            "circle-stroke-color": "#808080"
          }
        }, {
          "id": "npa-rta-2019-cluster-caption",
          "type": "symbol",
          "source": "npa-rta-2019",
          "source-layer": "npa-rta-2019",
          "minzoom": 0,
          "maxzoom": 24,
          "filter": ["has", "point_count"],
          "layout": {
            "text-field": ["get", "point_count"],
            "text-font": [
              "NotoSansCJKjp-Regular"
            ],
            "text-size": 12
          },
          "paint": {
            "text-color": "#000000"
          }
        }, {
          "id": "npa-rta-2019",
          "type": "circle",
          "source": "npa-rta-2019",
          "source-layer": "npa-rta-2019",
          "minzoom": 0,
          "maxzoom": 24,
          "filter": ["!", ["has", "point_count"]],
          "paint": {
            "circle-color": "#ffff00",
            "circle-radius": 8,
            "circle-stroke-width": 1,
            "circle-stroke-color": "#808080"
          }
        }
      ]
    };

    (async function() {

      const codebook = await (await fetch("codebook_2019.json")).json();
      const toHTML = function(properties) {
        const html = ["<div class='my-popup'>"];
        Object.keys(properties).forEach(k => {
          let v = properties[k];

          let normalizedKey = k;
          if (normalizedKey.match(/^(.+)#[0-9]+$/)) {
            normalizedKey = RegExp.$1;
          }
          if (normalizedKey === "警察署等コード") {
            v = properties["都道府県コード"] + ">" + properties[k];
          }

          if (normalizedKey === "祝日(発生年月日)") {
            normalizedKey = "祝日";
          }
          if (normalizedKey === "曜日(発生年月日)") {
            normalizedKey = "曜日";
          }
          if (normalizedKey.startsWith("発生日時")) {
            normalizedKey = "発生日時";
          }
          if (normalizedKey.match(/^(.+)\(当事者[AB]\)$/)) {
            normalizedKey = RegExp.$1;
          }

          const rosen = codebook["@graph"].find(a => a["rdfs:label"] === "路線(高速自動車国道,自動車専用道(指定))コード")["skos:hasTopConcept"];

          const cs = codebook["@graph"].find(a => a["rdfs:label"] === normalizedKey);
          if (cs && normalizedKey === "路線コード") {
            html.push(`<b title="${cs['rdfs:comment']}">${k}</b> `);

            const head = v.substring(0, 4);
            const tail = v.substring(4);
            const no = parseInt(head);
            if (no < 1000) {
              v = `一般国道（国道番号:${no}）`;
            } else if (no < 1500) {
              v = `主要地方道－都道府県道(${no})`;
            } else if (no < 2000) {
              v = `主要地方道－市道(${no})`;
            } else if (no < 3000) {
              v = `一般都道府県道(${no})`;
            } else if (no < 4000) {
              v = `一般市町村道(${no})`;
            } else if (no < 5000) {
              v = `高速自動車国道(${no})`;
              const z = rosen.find(x => x["skos:notation"] === properties["都道府県コード"] + ">" + head);
              if (z) v += z["skos:prefLabel"];
            } else if (no < 5500) {
              v = `自動車専用道－指定(${no})`;
              const z = rosen.find(x => x["skos:notation"] === properties["都道府県コード"] + ">" + head);
              if (z) v += z["skos:prefLabel"];
            } else if (no < 6000) {
              v = `自動車専用道－その他(${no})`;
            } else if (no < 7000) {
              v = `道路運送法上の道路(${no})`;
            } else if (no < 8000) {
              v = `農（免）道(${no})`;
            } else if (no < 8500) {
              v = `林道(${no})`;
            } else if (no < 9000) {
              v = `港湾道(${no})`;
            } else if (no < 9500) {
              v = `私道(${no})`;
            } else if (no === 9500) {
              v = `その他(${no})`;
            } else if (no === 9900) {
              v = `一般の交通の用に供するその他の道路(${no})`;
            }
            if (tail !== "0") v += `(バイパス区間:${tail})`;

            html.push(`<code>${v}</code><br/>`);
            /*
                        項目名 路線コード
            適用 本票
            交通事故が発生した道路をいう。
            コード（上４桁） 路線名 コード（下１桁） 区分
            0001～0999 一般国道（国道番号） 0 現道区間又は包括路線
            1000～1499  1～9 バイパス区間
            1500～1999
            2000～2999
            3000～3999
            4000～4999 高速自動車国道 *1
            5000～5499  *1
            5500～5999
            6000～6999
            7000～7999
            8000～8499
            8500～8999
            9000～9499
            9500
            9900

                        html.push(`<code>やるぜ${v}</code><br/>`);
              */
          } else if (cs && cs["skos:hasTopConcept"].length === 0) {
            html.push(`<b title="${cs['rdfs:comment']}">${k}</b> `);
            html.push(`<code>${v}</code><br/>`);
          } else if (cs) {

            html.push(`<b title="${cs['rdfs:comment']}">${k}</b> `);

            const c = cs["skos:hasTopConcept"].find(a => a["skos:notation"] === v);
            if (c) {
              v = `${c["skos:prefLabel"]} (${v})`;
              html.push(`<span>${v}</span><br/>`);
            } else {
              //              console.error("Concept not found : ", normalizedKey, v, cs);
              html.push(`<span>${v}</span><br/>`);
            }
          } else {
            //          console.error("ConceptScheme not found : ", normalizedKey);
            html.push(`<b>${k}</b> `);
            html.push(`<span>${v}</span><br/>`);
          }
        });
        html.push("</div>");
        return html.join("");
      };

      const map = new maplibregl.Map({
        "container": "map",
        "center": [139.68786, 35.68355],
        "zoom": 14.65,
        "pitch": 60,
        "bearing": 22,
        "hash": true,
        "style": style
      });

      map.addControl(new ExportControl());

      map.on("load", function() {

        const handler = function(e) {
          switch (e.type) {
            case "mouseenter":
              map.getCanvas().style.cursor = 'pointer';
              break;
            case "mouseleave":
              map.getCanvas().style.cursor = '';
              break;
            case "click":
              const dl = document.createElement("dl");
              const prop = e.features[0].properties;
              const html = toHTML(e.features[0].properties);
              new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(html)
                .addTo(map);
              break;
          }
        };

        style.layers.filter(a => a["source"] === "npa-rta-2019").forEach(layer => {
          ["click", "mouseenter", "mouseleave"].forEach(type => {
            map.on(type, layer.id, handler);
          });
        });
      });

    })();
  </script>
</body>

</html>
